<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Leer Online</title>
<style>
body { margin:0; padding:0; background:#1c1a13; color:#f5e6c4; font-family: 'Garamond', serif; }
#viewer { width: 100%; height: 100vh; background:#1c1a13; }
#controls { position: fixed; bottom: 10px; left: 50%; transform: translateX(-50%); z-index: 100; }
button { padding: 8px 12px; margin: 0 4px; font-size:14px; border-radius:6px; border:none; background:#b5884e; color:#fff; cursor:pointer; }
button:hover { background:#8b5f2c; }
</style>
<!-- CDN de epub.js -->
<script src="https://cdn.jsdelivr.net/npm/epubjs/dist/epub.min.js"></script>
</head>
<body>
<div id="viewer"></div>
<div id="controls">
  <button id="prev">⬅ Anterior</button>
  <button id="next">Siguiente ➡</button>
</div>

<script>
const params = new URLSearchParams(window.location.search);
const bookId = params.get('id');

if(!bookId){ 
    alert('No se encontró el libro'); 
    throw new Error('No se proporcionó id de libro');
}

// URL de Google Drive
const bookUrl = `https://drive.google.com/uc?export=download&id=${bookId}`;
const bookKey = `readPos_${bookId}`;

// Inicializamos el libro
const book = ePub(bookUrl);
const rendition = book.renderTo("viewer", { width:"100%", height:"100%" });

// Esperamos a que el libro esté listo
book.ready.then(() => {
    let storedLocation = localStorage.getItem(bookKey);
    if(storedLocation) {
        rendition.display(storedLocation);
    } else {
        rendition.display();
    }
});

// Guardar progreso al cambiar de ubicación
rendition.on('relocated', function(location){
    localStorage.setItem(bookKey, location.start.cfi);
});

// Controles
document.getElementById('prev').addEventListener('click', () => rendition.prev());
document.getElementById('next').addEventListener('click', () => rendition.next());

// Navegación con teclado
document.addEventListener('keydown', (e) => {
    if(e.key === 'ArrowLeft') rendition.prev();
    if(e.key === 'ArrowRight') rendition.next();
});
</script>
</body>
</html>
