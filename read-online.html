<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Lector EPUB</title>

<!-- EPUB.js desde CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/epub.js/0.3.88/epub.min.js"></script>

<style>
    body {
        margin: 0;
        padding: 0;
        background: #121212;
        color: #e0d6c2;
        font-family: "Garamond", serif;
        overflow: hidden;
    }

    a { 
        text-decoration: none !important;
        color: inherit !important;
    }

    #viewer {
        height: calc(100vh - 70px);
        width: 100%;
        background: #1d1b16;
        box-sizing: border-box;
    }

    #controls {
        height: 70px;
        background: #1a1814;
        border-top: 1px solid #3a352d;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 25px;
    }

    button {
        background: #3a352d;
        border: none;
        color: #f5e6c4;
        padding: 12px 22px;
        font-size: 16px;
        border-radius: 8px;
        cursor: pointer;
        transition: 0.2s;
    }

    button:hover {
        background: #5a5244;
    }
</style>

</head>
<body>

<div id="viewer"></div>

<div id="controls">
    <button id="prev">← Anterior</button>
    <button id="next">Siguiente →</button>
</div>


<script>

// Obtener ID del libro desde la URL
const params = new URLSearchParams(window.location.search);
const bookId = params.get("id");

if (!bookId) {
    document.body.innerHTML = "<h1 style='padding:20px;color:white;'>❌ Falta el parámetro id en la URL</h1>";
    throw new Error("Falta ?id= en read-online.html");
}

// Construir URL del servidor
const bookUrl = `/book/${bookId}`;
const bookKey = `pos_${bookId}`;

// Crear libro con EPUB.js
const book = ePub(bookUrl);

// Renderizado
const rendition = book.renderTo("viewer", {
    width: "100%",
    height: "100%",
    spread: "auto",
    flow: "paginated"
});

// Cargar última posición
const savedLocation = localStorage.getItem(bookKey);

if (savedLocation) {
    rendition.display(savedLocation);
} else {
    rendition.display();
}

// Guardar progreso
rendition.on("relocated", (location) => {
    localStorage.setItem(bookKey, location.start.cfi);
});

// Controles botones
document.getElementById("prev").addEventListener("click", () => {
    rendition.prev();
});
document.getElementById("next").addEventListener("click", () => {
    rendition.next();
});

// Controles teclado
document.addEventListener("keydown", (e) => {
    if (e.key === "ArrowLeft") rendition.prev();
    if (e.key === "ArrowRight") rendition.next();
});

</script>

</body>
</html>
